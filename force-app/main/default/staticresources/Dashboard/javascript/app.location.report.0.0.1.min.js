(function(b){var a=["Id","ProjectName__c","Project__c","ProjectTypeName__c","RetailerName__c","Retailer__c","ClientName__c","Client__c","Location__c","ProjectType__c","ClubNumber__c","StartDate__c","EndDate__c","ProjectStatus__c"],c=["Id","ProjectName__c","Project__c","ProjectTypeName__c","RetailerName__c","Retailer__c","Client__c","ClientId__c","ProjectType__c","Location__c","LocationNumber__c","ScheduleDate__c","Status__c","ServiceName__c","StartDate__c","EndDate__c"];b.module("cmk.location.report.model",["cmk.system.async","cmk.web.context"]).factory("cmkLocationReportModel",["cmkSystemAsync","cmkWebContext",function(g,f){function h(){return new SObjectModel.ProjectLocation__c()}function e(){return new SObjectModel.Job__c()}function j(l){var k=l.split("/");if(k.length!==3){return 0}return new Date(Date.UTC(parseInt(k[2]),parseInt(k[0])-1,parseInt(k[1]),0,0,0,0))}function d(k,m){var n,o,l={orderby:[{StartDate__c:"ASC"}],limit:100};l.where={};l.where.ProjectName__c={ne:""};l.where.StartDate__c={gt:new Date(1900,1,1,0,0,0,0)};if(k==="project"){l.where.ProjectStatus__c={eq:"Scheduled"};l.where.ClubNumber__c={ne:""}}else{if(k==="job"){l.where.Status__c={eq:"Scheduled"};l.where.LocationNumber__c={ne:""}}}if(!!m.startDate){n=j(m.startDate);if(!!n){l.where.StartDate__c={gte:n}}}if(!!m.endDate){n=j(m.endDate);if(!!n){l.where.endDate__c={lte:n}}}if(!!m.retailer){o=m.retailer.substr(0,15);l.where.Retailer__c={eq:o}}if(!!m.location){o=m.location.substr(0,15);l.where.Location__c={eq:o}}if(!!m.client){o=m.client.substr(0,15);if(k==="project"){l.where.Client__c={eq:o}}else{if(k==="job"){l.where.ClientId__c={eq:o}}}}if(!!m.projectType){o=m.projectType.substr(0,15);l.where.ProjectType__c={eq:o}}return l}function i(){}i.prototype.findProjects=function(l){var k=h(),m=d("project",l);return g.call(k.retrieve,m,a)};i.prototype.findJobs=function(l){var k=e(),m=d("job",l);return g.call(k.retrieve,m,c)};return new i()}])})(angular);(function(m){var f,l,c;function j(){var t=m.element("body").height()-m.element("div#pageBody").offset().top;return(t>400)?t-150:400}function p(t){var u={};u.client=t.filterModel.client||"";u.retailer=t.filterModel.retailer||"";u.projectType=t.filterModel.projectType||"";u.location=t.filterModel.location||"";u.startDate=t.filterModel.startDate||"";u.endDate=t.filterModel.endDate||"";return u}function i(t,w,y){var x,u=t.objectTypeViewModel.getSelKey(),v=p(t);if(u==="project"){y.findProjects(v).then(function(z){t.projectGridOptions.data=z;if(t.displayActionModel.getSelKey()==="month"){d(u,z)}})}else{if(u==="job"){y.findJobs(v).then(function(z){t.jobGridOptions.data=z;if(t.displayActionModel.getSelKey()==="month"){d(u,z)}})}else{w.log("The app is in invalid state");w.log(t.objectTypeViewModel)}}}function r(t){return{data:[],columnDefs:[{displayName:"Location #",field:"ClubNumber__c",cellTemplate:'<div class="cm-cell"><span class="label label--success">{{COL_FIELD}}</span></div>'},{displayName:"Retailer",field:"RetailerName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Project Title",field:"ProjectName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Client",field:"ClientName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Project Type",field:"ProjectTypeName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Execute Date",field:"StartDate__c",cellTemplate:'<div class="cm-cell truncate"><span>{{COL_FIELD.toISOString()}}</span></div>'},{displayName:"Status",field:"ProjectStatus__c"}],enableColumnMenu:false,onRegisterApi:function(u){t.gridApi=u},exporterFieldCallback:function(w,x,v,u){if(v.name=="ServiceName__c"){return(u==="-")?"":u}else{return u}}}}function k(t){return{data:[],columnDefs:[{displayName:"Location #",field:"LocationNumber__c",cellTemplate:'<div class="cm-cell"><span class="label label--success">{{COL_FIELD}}</span></div>'},{displayName:"Retailer",field:"RetailerName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Project Title",field:"ProjectName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Client",field:"Client__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Project Type",field:"ProjectTypeName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Service",field:"ServiceName__c",cellTemplate:'<div class="cm-cell truncate"><span ng-bind-html="COL_FIELD"></span></div>'},{displayName:"Execute Date",field:"StartDate__c",cellTemplate:'<div class="cm-cell truncate"><span>{{COL_FIELD.toISOString()}}</span></div>'},{displayName:"Status",field:"Status__c"}],enableColumnMenu:false,onRegisterApi:function(u){t.gridApi=u},exporterFieldCallback:function(w,x,v,u){if(v.name=="ServiceName__c"){return(u==="-")?"":u}else{return u}}}}function n(u,t,v){u.objectTypeViewModel.setSelKey(t);u.displayActionModel.setSelKey(v)}function e(v,u,x,w){var t=this;t.dataId=u;t.eventId=v;t.title=x;t.isHidden=w?1:0;t.displayMode="text";t.show=function(){t.isHidden=0};t.hide=function(){t.isHidden=1;t.dataId=""};t.setData=function(y){t.dataId=y[t.eventId];t.title=(t.eventId.indexOf("Date")!==-1)?y[t.eventId]:y[t.eventId+"Model"].selRow.value;t.isHidden=(!!t.dataId)?0:1}}function g(u,x,w){var v=this;v.startDate=u;v.endDate=x;v.title="";v.isHidden=w?1:0;v.displayMode="text";function t(){if(!!v.startDate&&!!v.endDate){v.title=[v.startDate,v.endDate].join(" - ")}else{if(!!v.startDate){v.title=["Exec.Date >=",v.startDate].join(" ")}else{if(!!v.endDate){v.title=["Exec.Date <=",v.endDate].join(" ")}else{v.title=""}}}}v.setData=function(y){v.startDate=y.startDate;v.endDate=y.endDate;t();v.isHidden=(!!v.startDate||!!v.endDate)?0:1}}function a(v){var x=v,A,B,u,y={};y.client="";y.retailer="";y.location="";y.projectType="";y.startDate="";y.endDate="";y.clientModel=undefined;y.retailerModel=undefined;y.locationModel=undefined;y.projectTypeModel=undefined;function z(G,D){var E,F=G;if(!!D){E=D.toLowerCase();F=[];G.forEach(function(H){if(H.Name.indexOf(E)!==-1){F.push(H)}})}return F}y.resetSelection=function(E){var D;y[E]="";D=y[E+"Model"];D.selRow.key="";D.selRow.value=""};y.findClients=function(D){y.clientModel.rowset=z(B,D)};y.findRetailers=function(D){y.retailerModel.rowset=z(A,D)};y.findLocations=function(D){x.findLocations(D).then(function(G){var F,E=[];if(!!G){G.forEach(function(H){F={};F.Id=H.Id;F.Num="<span class='label label--success'>"+H.LocationNumber__c+"</span>";F.Name=H.Name;F.Address=H.Address__c;F.retailerId=H.Retailer__c;F.City=H.City__c;F.State=H.State__c;E.push(F)})}y.locationModel.rowset=E;if(!y.locationModel.selRow){y.locationModel.selRow={key:"",value:""}}})};y.findProjectTypes=function(D){y.projectTypeModel.rowset=z(u,D)};function t(){x.getRetailers().then(function(D){A=D;y.retailerModel={selRow:{key:"",value:""},rowset:D}})}function C(){var D=[];x.getClients().then(function(E){E.forEach(function(F){D.push({Id:F.Id,Name:F.ClientName__c})});B=D;y.clientModel={selRow:{key:"",value:""},rowset:D}})}function w(){x.getProjectTypes().then(function(D){u=D;y.projectTypeModel={selRow:{key:"",value:""},rowset:D}})}y.init=function(){t();C();w()};return y}function q(){var t=this;t.title="DISPLAY AS";t.helpText="Data Layout Options";t.buttonUrl=f+"/assets/icons/utility-sprite/svg/symbols.svg#monthlyview";t.canSelect=1;t.showSelectIcon=1;t.setSelectIcon=1;t.menuItems=[{key:"table",value:"Table",leftIconUrl:"",rightIconUrl:f+"/assets/icons/utility-sprite/svg/symbols.svg#table",disabled:0},{key:"month",value:"Month",leftIconUrl:"",rightIconUrl:f+"/assets/icons/utility-sprite/svg/symbols.svg#monthlyview",selected:1,disabled:0}];t.getSelKey=function(){var u=_.find(t.menuItems,function(v){return v.selected===1});return !!u?u.key:"table"};t.setSelKey=function(u){t.menuItems.forEach(function(v){v.selected=(v.key===u)?1:0})}}function s(){var t=this;t.option={key:"project",value:"Project View"};t.options=[{key:"project",value:"Project View"},{key:"job",value:"Job View"}];t.getSelKey=function(){return t.option.key};t.setSelKey=function(v){if(t.option.key!==v){var u=_.find(t.options,function(w){return w.key===v});if(!!u){t.option.key=u.key;t.option.value=u.value}}}}function o(u,A){var w=[],t,z,v=[],x,y=(u==="project")?"ClubNumber__c":"LocationNumber__c";A.forEach(function(E){t=Date.parse(E.StartDate__c);z=Date.parse(E.EndDate__c);w.push({title:[E[y],E.ProjectTypeName__c].join(": "),start:moment(t).toISOString(),end:moment(z).toISOString(),color:"steelblue"});var C,D=moment(z).diff(moment(t),"days");for(var B=0;B<D;B++){C=moment(t).add(B,"days").unix()+"";if(!!C){if(!!v[C]){v[C]+=1}else{v[C]=1}}}});return{events:w,eventCounts:v}}function d(t,w){var u=["div#",t,"Calendar"].join(""),x=o(t,w),v=m.element(u);v.fullCalendar("removeEvents");v.fullCalendar("addEventSource",x.events);c.render(x.eventCounts)}function b(u,t){var z=undefined,x=["div#",t,"Calendar"].join(""),v=["#",t,"HeatMap","-g-PreviousDomain-selector"].join(""),y=["#",t,"HeatMap","-g-NextDomain-selector"].join("");function w(){}w.prototype.render=function(A){if(!!z){z.update(A)}else{z=new CalHeatMap();z.init({itemSelector:u,domain:"month",subDomain:"x_day",data:A,weekStartOnMonday:false,legend:[1,3,5,10],legendColors:{min:"#efefef",max:"steelblue",empty:"white",overflow:"red"},cellSize:25,cellPadding:5,verticalOrientation:true,cellRadius:0,considerMissingDataAsZero:true,domainGutter:0,range:3,domainDynamicDimension:true,previousSelector:v,nextSelector:y,domainLabelFormat:function(B){moment.locale("en");return moment(B).format("MMMM").toUpperCase()},label:{position:"top"},onClick:function(C,B){m.element(x).fullCalendar("changeView","agendaDay");m.element(x).fullCalendar("gotoDate",C)},subDomainTextFormat:"%d"})}};return new w()}function h(t){var u=["div#",t,"Calendar"].join(""),v=["div#",t,"HeatMap"].join("");m.element(u).fullCalendar({header:{left:"prev,next",center:"title",right:"month,agendaWeek,agendaDay"},allDayDefault:true,eventLimit:5,businessHours:true,editable:true,height:j()+40});c=new b(v,t)}m.module("app.location.report",["cmk.web.context","cmk.system.async","cmk.service.lookupModel","cmk.location.report.model","cmk.ui.picklist","cmk.ui.dropdown","cmk.ui.dropdown.area","cmk.ui.lookup","cmk.ui.pill","cmk.ui.pagelet","ngSanitize","ui.router","ui.grid.autoResize","ui.grid","ui.grid.selection","ui.grid.exporter"]).config(["$stateProvider","$urlRouterProvider",function(t,u){u.otherwise("/projects-calendar-viewer");t.state("projects-table-viewer",{url:"/projects-table-viewer",template:'<div class="cm-col-container"><div cmk-pagelet="1" options="projectPageletModel" navbar-click="onNavBarClick(href)"><div ui-grid="projectGridOptions" class="cm-grid" ui-grid-exporter ui-grid-auto-resize></div></div></div>',controller:function(v){v.projectPageletModel={title:"Project List",canExpand:true,height:j(),navBars:[{id:"app_export_csv",text:"Export to CSV File",iconUrl:f+"/assets/icons/utility-sprite/svg/symbols.svg#download"}],footerHTML:""};l.findProjects(p(v)).then(function(w){v.projectGridOptions.data=w});v.export_row_type="all";v.export_column_type="all";v.export_format="csv";v.onNavBarClick=function(w){v.gridApi.exporter.csvExport(v.export_row_type,v.export_column_type)};n(v,"project","table")}}).state("jobs-table-viewer",{url:"/jobs-table-viewer",template:'<div class="cm-col-container"><div cmk-pagelet="1" options="jobPageletModel" navbar-click="onNavBarClick(href)"><div ui-grid="jobGridOptions" class="cm-grid" ui-grid-exporter ui-grid-auto-resize></div></div></div>',controller:function(v){v.jobPageletModel={title:"Job List",canExpand:true,height:j(),navBars:[{id:"app_export_csv",text:"Export to CSV File",iconUrl:f+"/assets/icons/utility-sprite/svg/symbols.svg#download"}],footerHTML:""};v.export_row_type="all";v.export_column_type="all";v.export_format="csv";v.onNavBarClick=function(w){v.gridApi.exporter.csvExport(v.export_row_type,v.export_column_type)};l.findJobs(p(v)).then(function(w){v.jobGridOptions.data=w});n(v,"job","table")}}).state("projects-calendar-viewer",{url:"/projects-calendar-viewer",template:'<div class="cm-col-container"><div cmk-pagelet="1" options="projectCalendarPageletModel" on-resize="onResize(height)"><div class="grid cm-row wrap"><div class="cm-heatmap"><div id="projectHeatMap"></div></div><div class="cm-full-cal"><div id="projectCalendar"></div></div></div></div></div>',controller:function(v){v.projectCalendarPageletModel={title:"Projects - Calendar",canExpand:true,height:j(),navBars:[],footerHTML:""};v.onResize=function(w){m.element("div#pageBody").find("div.cm-article-body").height(w)};l.findProjects(p(v)).then(function(w){h("project");d("project",w)});n(v,"project","month")}}).state("jobs-calendar-viewer",{url:"/jobs-calendar-viewer",template:'<div class="cm-col-container"><div cmk-pagelet="1" options="jobCalendarPageletModel" on-resize="onResize(height)"><div class="grid cm-row wrap"><div class="cm-heatmap"><div id="jobHeatMap"></div></div><div class="cm-full-cal"><div id="jobCalendar"></div></div></div></div></div>',controller:function(v){v.jobCalendarPageletModel={title:"Jobs - Calendar",canExpand:true,height:j(),navBars:[],footerHTML:""};v.onResize=function(w){m.element("div#pageBody").find("div.cm-article-body").height(w)};l.findJobs(p(v)).then(function(w){h("job");d("job",w)});n(v,"job","month")}})}]).factory("appLocationReportModel",["cmkSystemAsync","cmkServiceLookupModel","cmkLocationReportModel","cmkWebContext",function(v,t,x,u){function w(){}w.prototype.getClients=function(){return t.clients()};w.prototype.getRetailers=function(){return t.retailers()};w.prototype.getProjectTypes=function(){return t.projectTypes()};w.prototype.findLocations=function(y){return t.findLocations(y)};w.prototype.findProjects=function(y){return x.findProjects(y)};w.prototype.findJobs=function(y){return x.findJobs(y)};return new w()}]).controller("LocationReportController",["$scope","$state","cmkWebContext","$log","appLocationReportModel","$timeout",function(t,y,w,A,v,x){var z=t;f=w.staticResourcePath;l=v;z.objectTypeViewModel=new s();z.displayActionModel=new q();z.filterModel=new a(v);z.clientPillModel=new e("client","","",true);z.retailerPillModel=new e("retailer","","",true);z.locationPillModel=new e("location","","",true);z.projectTypePillModel=new e("projectType","","",true);z.dateRangePillModel=new g("","",true);z.jobGridOptions=k(z);z.projectGridOptions=r(z);function u(B,C){if(B==="project"){if(C==="table"){y.go("projects-table-viewer")}else{y.go("projects-calendar-viewer")}}else{if(C==="table"){y.go("jobs-table-viewer")}else{y.go("jobs-calendar-viewer")}}}z.initFilter=function(){z.filterModel.init();m.element('input[data-role="date"]').datepicker({changeMonth:true,changeYear:true,showOtherMonths:true,selectOtherMonths:false})};z.lookupRetailers=function(B){z.filterModel.findRetailers(B)};z.retailerChanged=function(){z.retailerPillModel.setData(z.filterModel);i(z,A,v)};z.onRetailerRemove=function(){z.retailerPillModel.hide();z.filterModel.resetSelection("retailer");i(z,A,v)};z.lookupClients=function(B){z.filterModel.findClients(B)};z.clientChanged=function(){z.clientPillModel.setData(z.filterModel);i(z,A,v)};z.onClientRemove=function(){z.clientPillModel.hide();z.filterModel.resetSelection("client");i(z,A,v)};z.lookupProjectTypes=function(B){z.filterModel.findProjectTypes(B)};z.projectTypeChanged=function(){z.projectTypePillModel.setData(z.filterModel);i(z,A,v)};z.onProjectTypeRemove=function(){z.projectTypePillModel.hide();z.filterModel.resetSelection("projectType");i(z,A,v)};z.lookupLocations=function(B){z.filterModel.findLocations(B)};z.locationChanged=function(){z.locationPillModel.setData(z.filterModel);i(z,A,v)};z.onLocationRemove=function(){z.locationPillModel.hide();z.filterModel.resetSelection("location");i(z,A,v)};z.startDateChanged=function(){z.dateRangePillModel.setData(z.filterModel);i(z,A,v)};z.onDateRangeRemove=function(){z.filterModel.startDate="";z.filterModel.endDate="";z.dateRangePillModel.setData(z.filterModel);i(z,A,v)};z.endDateChanged=function(){z.dateRangePillModel.setData(z.filterModel);i(z,A,v)};z.locationRowSelected=function(C){var B=C.Num.replace("</span>","");return B.substr(B.indexOf(">")+1)+" "+C.Name+" "+C.Address+" "+C.City+" "+C.State};z.displayActionClicked=function(B){u(z.objectTypeViewModel.getSelKey(),B)};z.onViewTypeChanged=function(){u(z.objectTypeViewModel.getSelKey(),z.displayActionModel.getSelKey())}}])})(angular);